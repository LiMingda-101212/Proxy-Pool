name: Proxy Crawler Debug

on:
  workflow_dispatch:

jobs:
  crawl-proxies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Debug - Check directory structure
      run: |
        echo "=== å½“å‰ç›®å½• ==="
        pwd
        echo "=== ç›®å½•å†…å®¹ ==="
        ls -la
        echo "=== proxy-pool ç›®å½• ==="
        ls -la proxy-pool/
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        cd proxy-pool
        echo "=== å®‰è£…ä¾èµ– ==="
        pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ requests aiohttp
        echo "ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: Run proxy crawler (ç®€åŒ–æµ‹è¯•)
      run: |
        cd proxy-pool
        echo "=== å¼€å§‹æ‰§è¡Œè„šæœ¬ ==="
        # å…ˆåˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œç¡®ä¿è„šæœ¬èƒ½è¿è¡Œ
        python -c "
        import csv
        print('Python ç¯å¢ƒæ­£å¸¸')
        print('requests æ¨¡å—æ­£å¸¸')
        
        # åˆ›å»ºæµ‹è¯•ä»£ç†æ–‡ä»¶
        with open('proxies.csv', 'w', newline='') as f:
            writer = csv.writer(f)
            writer.writerow(['http', '127.0.0.1:8080', 100])
            writer.writerow(['socks5', '192.168.1.1:1080', 95])
        print('æµ‹è¯•æ–‡ä»¶åˆ›å»ºå®Œæˆ')
        "
        echo "=== ç®€åŒ–æµ‹è¯•å®Œæˆ ==="
        
    - name: Check created file
      run: |
        echo "=== æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ ==="
        ls -la proxy-pool/proxies.csv
        echo "=== æ–‡ä»¶å†…å®¹ ==="
        cat proxy-pool/proxies.csv
        
    - name: Test Git operations step by step
      run: |
        echo "=== å¼€å§‹ Git æµ‹è¯• ==="
        
        # 1. é…ç½® Git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        echo "Git é…ç½®å®Œæˆ"
        
        # 2. æ£€æŸ¥çŠ¶æ€
        echo "=== Git çŠ¶æ€ ==="
        git status
        
        # 3. æ·»åŠ æ–‡ä»¶
        echo "=== æ·»åŠ æ–‡ä»¶ ==="
        git add proxy-pool/proxies.csv
        git status
        
        # 4. æäº¤
        echo "=== æäº¤å˜æ›´ ==="
        git commit -m "ğŸ¤– Test: Update proxy list" || echo "æäº¤å¤±è´¥"
        
        # 5. æ¨é€
        echo "=== æ¨é€å˜æ›´ ==="
        git push || echo "æ¨é€å¤±è´¥"
        
        echo "=== Git æµ‹è¯•å®Œæˆ ==="
